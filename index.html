<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sepsis Risk Prediction System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p { font-size: 1.2rem; opacity: 0.9; }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: fadeInUp 0.8s ease-out;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group { display: flex; flex-direction: column; }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input::placeholder { color: #999; font-style: italic; font-size: 0.9rem; }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .section-title {
            color: #667eea;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .btn-container { display: flex; gap: 15px; margin-top: 30px; }

        .btn {
            flex: 1;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-predict {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-predict:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }

        .btn-reset { background: #6c757d; color: white; }
        .btn-reset:hover { background: #5a6268; }

        .result-container {
            margin-top: 30px;
            padding: 30px;
            border-radius: 15px;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .result-high-risk {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
        }

        .result-medium-risk {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #1f1f1f;
        }

        .result-low-risk {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
        }

        .result-container h2 { font-size: 2rem; margin-bottom: 15px; text-align: center; }
        .result-container p { font-size: 1.2rem; text-align: center; opacity: 0.95; }

        .loading { display: none; text-align: center; padding: 20px; }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            animation: shake 0.5s ease-out;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        .info-badge {
            display: inline-block;
            background: #e7f3ff;
            color: #0066cc;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            margin-left: 8px;
            font-weight: 500;
        }

        .abnormal-values {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            border-left: 4px solid #0dcaf0;
        }

        .abnormal-values h3 { font-size: 1.3rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }

        .abnormal-list { list-style: none; padding: 0; }

        .abnormal-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .show-details-btn {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            display: none;
        }

        .show-details-btn:hover { background: rgba(255, 255, 255, 0.5); transform: translateY(-2px); }

        .hidden { display: none; }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .form-grid { grid-template-columns: 1fr; }
            .btn-container { flex-direction: column; }
        }

        .example-btn {
            background: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .example-btn:hover { background: #138496; transform: translateY(-2px); }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ü©∫ Sepsis Risk Prediction System</h1>
            <p>Predict Sepsis risk 12 hours in advance using ICU vitals & labs</p>

            <div style="background: rgba(255, 255, 255, 0.95); color: #333; padding: 20px; border-radius: 15px; margin-top: 20px; max-width: 900px; margin-left: auto; margin-right: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <h3 style="color: #667eea; margin-bottom: 12px; font-size: 1.3rem;">üìã Clinical Decision Support Tool</h3>
                <p style="line-height: 1.8; font-size: 1rem; margin-bottom: 10px;">
                    <strong>For ICU / Hospital Use:</strong> Enter vitals, labs, and patient demographics to estimate Sepsis risk.
                </p>
                <p style="line-height: 1.8; font-size: 1rem; color: #666;">
                    <strong>‚ö†Ô∏è Important:</strong> This tool supports clinical decision-making only. Always validate with professional judgement.
                </p>
            </div>
        </div>
        <div style="
            background:#fff3cd;
            color:#664d03;
            padding:14px;
            border-radius:12px;
            margin-top:15px;
            border-left:6px solid #ffc107;
            font-size:0.9rem;
            line-height:1.6;
        ">
        <strong>‚ÑπÔ∏è Model Interpretation</strong><br>
        This model estimates the <strong>risk of sepsis developing in the next 12 hours</strong>.
        A low risk score does <strong>not</strong> mean the patient is clinically stable or not septic.
        Always interpret results together with vitals, labs, and clinical judgment.
        </div>

        <div class="card">
            <button class="example-btn" onclick="fillExampleData()">üìã Load Example Patient Data</button>

            <form id="predictionForm">

                <div class="section-title">üë§ Patient Demographics</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="anchor_age">Age <span class="info-badge">Years</span></label>
                        <input type="number" id="anchor_age" name="anchor_age" min="0" max="120" placeholder="e.g., 64" required />
                    </div>

                    <div class="form-group">
                        <label for="gender">Gender <span class="info-badge">0/1</span></label>
                        <select id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="0">Female (0)</option>
                            <option value="1">Male (1)</option>
                        </select>
                    </div>
                </div>

                <div class="section-title">üìä ICU Vital Signs</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="hr">Heart Rate <span class="info-badge">bpm</span></label>
                        <input type="number" step="0.01" id="hr" name="hr" placeholder="e.g., 112" required />
                    </div>

                    <div class="form-group">
                        <label for="map">Mean Arterial Pressure (MAP) <span class="info-badge">mmHg</span></label>
                        <input type="number" step="0.01" id="map" name="map" placeholder="e.g., 68" required />
                    </div>

                    <div class="form-group">
                        <label for="rr">Respiratory Rate <span class="info-badge">/min</span></label>
                        <input type="number" step="0.01" id="rr" name="rr" placeholder="e.g., 24" required />
                    </div>

                    <div class="form-group">
                        <label for="temp_c">Temperature <span class="info-badge">¬∞C</span></label>
                        <input type="number" step="0.01" id="temp_c" name="temp_c" placeholder="e.g., 38.4" required />
                    </div>

                    <div class="form-group">
                        <label for="spo2">SpO2 <span class="info-badge">%</span></label>
                        <input type="number" step="0.01" id="spo2" name="spo2" min="0" max="100" placeholder="e.g., 92" required />
                    </div>
                </div>

                <div class="section-title">üî¨ Labs & Organ Dysfunction Markers</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="creatinine">Creatinine <span class="info-badge">mg/dL</span></label>
                        <input type="number" step="0.01" id="creatinine" name="creatinine" placeholder="e.g., 2.1" required />
                    </div>

                    <div class="form-group">
                        <label for="bilirubin">Bilirubin <span class="info-badge">mg/dL</span></label>
                        <input type="number" step="0.01" id="bilirubin" name="bilirubin" placeholder="e.g., 1.8" required />
                    </div>

                    <div class="form-group">
                        <label for="platelets">Platelets <span class="info-badge">K/uL</span></label>
                        <input type="number" step="0.01" id="platelets" name="platelets" placeholder="e.g., 95" required />
                    </div>

                    <div class="form-group">
                        <label for="lactate">Lactate <span class="info-badge">mmol/L</span></label>
                        <input type="number" step="0.01" id="lactate" name="lactate" placeholder="e.g., 3.6" required />
                    </div>

                    <div class="form-group">
                        <label for="urine_output_6h_ml">Urine Output (6h) <span class="info-badge">mL</span></label>
                        <input type="number" step="0.01" id="urine_output_6h_ml" name="urine_output_6h_ml" placeholder="e.g., 210" required />
                    </div>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn btn-predict">üîç Predict Sepsis Risk</button>
                    <button type="reset" class="btn btn-reset">üîÑ Reset Form</button>
                </div>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing ICU patient data...</p>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div class="result-container" id="resultContainer">
                <h2 id="resultTitle"></h2>
                <p id="resultMessage"></p>

                <div class="abnormal-values hidden" id="abnormalValues">
                    <h3>üìå Notes</h3>
                    <ul class="abnormal-list" id="abnormalList"></ul>
                </div>

                <button class="show-details-btn" id="showDetailsBtn" onclick="toggleAbnormalValues()">
                    Show Details
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/predict';

        // simple clinical thresholds (for UI "notes", not diagnosis)
        const ranges = {
            hr: { min: 60, max: 100, label: "Heart Rate", unit: "bpm" },
            map: { min: 65, max: 120, label: "MAP", unit: "mmHg" },
            rr: { min: 12, max: 20, label: "Respiratory Rate", unit: "/min" },
            temp_c: { min: 36.1, max: 37.8, label: "Temperature", unit: "¬∞C" },
            spo2: { min: 95, max: 100, label: "SpO2", unit: "%" },
            creatinine: { min: 0.4, max: 1.2, label: "Creatinine", unit: "mg/dL" },
            bilirubin: { min: 0.1, max: 1.2, label: "Bilirubin", unit: "mg/dL" },
            platelets: { min: 150, max: 450, label: "Platelets", unit: "K/uL" },
            lactate: { min: 0.5, max: 2.0, label: "Lactate", unit: "mmol/L" },
            urine_output_6h_ml: { min: 300, max: 5000, label: "Urine Output (6h)", unit: "mL" } // rough threshold
        };

        function checkAbnormalValues(data) {
            const abnormal = [];
            for (const [key, value] of Object.entries(data)) {
                if (ranges[key]) {
                    const r = ranges[key];
                    if (value < r.min || value > r.max) {
                        abnormal.push({
                            label: r.label, value, unit: r.unit,
                            min: r.min, max: r.max,
                            status: value < r.min ? "Low" : "High"
                        });
                    }
                }
            }
            return abnormal;
        }

        function displayNotes(abnormalValues) {
            const list = document.getElementById('abnormalList');
            const box = document.getElementById('abnormalValues');
            const btn = document.getElementById('showDetailsBtn');

            if (abnormalValues.length === 0) {
                btn.style.display = "none";
                box.classList.add("hidden");
                return;
            }

            list.innerHTML = '';
            abnormalValues.forEach(item => {
                const li = document.createElement('li');
                li.className = 'abnormal-item';
                li.innerHTML = `
                    <span><strong>${item.label}:</strong> ${item.value} ${item.unit}</span>
                    <span style="font-size: 0.9em; opacity: 0.9;">
                        ${item.status} (Ref: ${item.min} - ${item.max} ${item.unit})
                    </span>
                `;
                list.appendChild(li);
            });

            btn.style.display = "inline-block";
            box.classList.add("hidden");
        }

        function toggleAbnormalValues() {
            const box = document.getElementById('abnormalValues');
            const btn = document.getElementById('showDetailsBtn');

            if (box.classList.contains('hidden')) {
                box.classList.remove('hidden');
                btn.textContent = "Hide Details";
            } else {
                box.classList.add('hidden');
                btn.textContent = "Show Details";
            }
        }

        function fillExampleData() {
            document.getElementById('hr').value = 112;
            document.getElementById('map').value = 68;
            document.getElementById('rr').value = 24;
            document.getElementById('temp_c').value = 38.4;
            document.getElementById('spo2').value = 92;
            document.getElementById('creatinine').value = 2.1;
            document.getElementById('bilirubin').value = 1.8;
            document.getElementById('platelets').value = 95;
            document.getElementById('lactate').value = 3.6;
            document.getElementById('urine_output_6h_ml').value = 210;
            document.getElementById('anchor_age').value = 64;
            document.getElementById('gender').value = 1;
        }

        function riskLabelToUI(prob, threshold) {

            if (prob >= threshold) {
                return {
                    className: "result-container result-high-risk",
                    title: "‚ö†Ô∏è High Sepsis Risk",
                    message: `High risk detected. Model probability: ${(prob * 100).toFixed(2)}%.`
                };
            }

            if (prob >= threshold * 0.6) {
                return {
                    className: "result-container result-medium-risk",
                    title: "üü° Moderate Sepsis Risk",
                    message: `Moderate risk detected. Model probability: ${(prob * 100).toFixed(2)}%.`
                };
            }

            return {
                className: "result-container result-low-risk",
                title: "Low Sepsis Risk",
                message: `Low risk detected. Model probability: ${(prob * 100).toFixed(2)}%.`
            };
        }


        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const loading = document.getElementById('loading');
            const resultContainer = document.getElementById('resultContainer');
            const errorMessage = document.getElementById('errorMessage');

            resultContainer.style.display = 'none';
            errorMessage.style.display = 'none';
            loading.style.display = 'block';

            const formData = new FormData(e.target);

            const payload = {};
            formData.forEach((value, key) => {
                // everything except gender is float/int; gender & anchor_age -> int
                if (key === "gender" || key === "anchor_age") payload[key] = parseInt(value, 10);
                else payload[key] = parseFloat(value);
            });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                loading.style.display = 'none';

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || "Prediction failed");
                }

                const result = await response.json();

                // show UI result
                resultContainer.style.display = 'block';

                // result format: {prediction:int, probability:float, risk_label:str}
                const prob = parseFloat(result.sepsis_risk_score);
                const threshold = parseFloat(result.decision_threshold);

                // üî• threshold-aware UI decision
                const ui = riskLabelToUI(prob, threshold);


                // üî• APPLY RESULT TO UI (THIS WAS MISSING)
                resultContainer.className = ui.className;
                document.getElementById('resultTitle').textContent = ui.title;
                document.getElementById('resultMessage').textContent = ui.message;

                // optional: show clinical note
                if (result.clinical_note) {
                    document.getElementById('resultMessage').textContent +=
                        `\n${result.clinical_note}`;
                }

                // UI notes based on simple thresholds
                const abnormal = checkAbnormalValues(payload);
                displayNotes(abnormal);

            } catch (error) {
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = "‚ùå Error: " + error.message;
            }
        });

        document.querySelector('.btn-reset').addEventListener('click', () => {
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('abnormalValues').classList.add("hidden");
            document.getElementById('showDetailsBtn').style.display = "none";
        });
    </script>
</body>
</html>
